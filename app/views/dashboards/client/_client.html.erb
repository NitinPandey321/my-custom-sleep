<div class="client-item">
  <div class="client-info">
    <% profile_path = dashboards_client_view_for_coach_path(client_id: client.id) %>

    <% if client.profile_picture.attached? %>
      <%= link_to profile_path, class: "no-link" do %>
        <img id="profile-pic" 
            src="<%= rails_blob_url(client.profile_picture, disposition: 'inline') %>" 
            alt="Profile picture"
            style="width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer;"
            class="profile-picture" />
      <% end %>
    <% else %>
      <%= link_to profile_path, class: "no-link" do %>
        <div class="client-avatar red" 
            style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; cursor: pointer;">
          <%= client.initials %>
        </div>
      <% end %>
    <% end %>

    <div class="client-text">
      <h4><%= client.full_name %></h4>
      <p><%=
              case client.today_reflection&.mood
              when "happy" then "ðŸ˜Š Happy"
              when "neutral" then "ðŸ˜ Neutral"
              when "tired" then "ðŸ˜´ Tired"
              else client.today_reflection&.mood
              end
            %> â€¢ <%= client.plan_streak %>-Plan streak</p>
    </div>
  </div>

  <% if show_actions %>
    <div class="client-actions">
      <%= link_to dashboards_logs_path(client_id: client.id), class: "btn btn-logs", data: { turbo: false } do %>
        <i class="fas fa-list"></i>
        
      <% end %>

      <span class="status-badge <%= client.status %>"><%= client.status.titleize %></span>
      <%= link_to "+ Plan", "#{dashboards_coach_path(client_id: client.id)}#create-plan-form", class: "btn-plan", data: { action: "scroll-to-form" } %>
      <div data-controller="floating-chat">
        <% conversation = Conversation.between(client.id, current_user.id) %>
       <%= link_to dashboards_coach_path(recipient_id: client.id),
            class: "open-chat-btn" do %>
          ðŸ’¬
          <% if conversation %>
            <%= render "conversations/unread_badge", conversation: conversation, viewer: current_user %>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('[data-action="scroll-to-form"]').forEach(function (el) {
      el.addEventListener("click", function (e) {
        const target = document.querySelector("#create-plan-form");
        if (target) {
          e.preventDefault();
          target.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    });
  });
</script>
