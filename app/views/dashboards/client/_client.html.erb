<div class="client-item">
  <div class="client-info">
    <% if client.profile_picture.attached? %>
      <img id="profile-pic" 
           src="<%= rails_blob_url(client.profile_picture, disposition: 'inline') %>" 
           alt="Profile picture"
           style="width: 40px; height: 40px; border: none;"
           class="profile-picture" />
    <% else %>
      <div class="client-avatar red"><%= client.initials %></div>
    <% end %>

    <div class="client-text">
      <h4><%= client.full_name %></h4>
      <p><%=
              case client.today_reflection&.mood
              when "happy" then "😊 Happy"
              when "neutral" then "😐 Neutral"
              when "tired" then "😴 Tired"
              else client.today_reflection&.mood
              end
            %> • <%= client.plan_streak %>-Plan streak</p>
    </div>
  </div>

  <% if show_actions %>
    <div class="client-actions">
      <% if client.oura_access_token? %>
        <%= link_to dashboard_v2_oura_dashboard_index_path(client_id: client.id), class: "btn btn-connected" , data: { turbo: false } do %>
          <i class="fas fa-heartbeat"></i>
          Oura
        <% end %>
      <% end %>

      <%= link_to dashboards_logs_path(client_id: client.id), class: "btn btn-logs", data: { turbo: false } do %>
        <i class="fas fa-list"></i>
        
      <% end %>

      <span class="status-badge <%= client.status %>"><%= client.status.titleize %></span>
      <%= link_to "+ Plan", "#{dashboards_coach_path(client_id: client.id)}#create-plan-form", class: "btn-plan", data: { action: "scroll-to-form" } %>
      <div data-controller="floating-chat">
        <% conversation = Conversation.between(client.id, current_user.id) %>
       <%= link_to dashboards_coach_path(recipient_id: client.id),
            class: "open-chat-btn" do %>
          💬
          <% if conversation %>
            <%= render "conversations/unread_badge", conversation: conversation, viewer: current_user %>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('[data-action="scroll-to-form"]').forEach(function (el) {
      el.addEventListener("click", function (e) {
        const target = document.querySelector("#create-plan-form");
        if (target) {
          e.preventDefault();
          target.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    });
  });
</script>
