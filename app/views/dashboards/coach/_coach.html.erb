<div data-controller="floating-chat">
  <div class="coach-card">
    <div class="coach-info">
      <div class="coach-avatar">
        <% if coach.profile_picture.attached? %>
          <img src="<%= rails_blob_url(coach.profile_picture, disposition: 'inline') %>" 
               alt="Coach Profile Picture" 
               class="profile-picture" />
        <% else %>
          <div class="coach-avatar-placeholder"><%= coach.initials %></div>
        <% end %>
        <span class="online-dot"></span>
      </div>
      <div class="coach-details">
        <h3><%= coach.full_name %> <span class="coach-role">(Your Coach)</span></h3>
        <p class="status-online">Online now</p>
        <p class="coach-speciality">Sleep Specialist</p>
      </div>
    </div>

    <div class="coach-actions">
      <%= link_to "#",
          class: "open-chat-btn",
          data: { action: "click->floating-chat#open" } do %>
        ðŸ’¬ Start Chat
        <%# ðŸ”¥ This is the badge we will update dynamically %>
        <span id="unread_count_user_<%= coach.id %>" class="chat-badge">
          <%= current_user.unread_messages_count(coach) %>
        </span>
      <% end %>
    </div>
  </div>

  <!-- Floating chat panel -->
  <div data-floating-chat-target="panel" class="floating-chat">
    <div class="chat-header">
      Chat with <%= coach.full_name %>
      <button data-action="click->floating-chat#close">âœ–</button>
    </div>

    <%= turbo_frame_tag "chat_box" do %>
      <%= render 'active_chats_card', conversation: @conversation, messages: @messages, new_message: @new_message %>
    <% end %>
  </div>
</div>
