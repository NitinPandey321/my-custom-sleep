<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - My Custom Sleep Journey</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="auth-body">
    <%= render 'shared/flash_messages' %>
    
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h1>Reset Password</h1>
          <p>Enter your new password below. Make sure it's strong and secure.</p>
        </div>

        <%= form_with model: @user, url: password_path(@user), method: :patch, local: true, class: "auth-form" do |form| %>
          <div class="form-group">
            <%= form.label :password, "New Password", class: "form-label" %>
            <div class="password-input-wrapper" data-controller="password-visibility">
              <%= form.password_field :password, 
                  placeholder: "Enter new password", 
                  class: "form-input password-input",
                  required: true,
                  minlength: 6,
                  autocomplete: "new-password",
                  data: { "password-visibility-target": "input" },
                  "aria-label": "Password is hidden" %>
              <button type="button" 
                      class="password-toggle-btn" 
                      data-action="click->password-visibility#toggle"
                      aria-label="Toggle password visibility">
                <span class="password-toggle-icon" data-password-visibility-target="icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="#0e3264" stroke-width="2" fill="none"/>
                    <circle cx="12" cy="12" r="3" stroke="#0e3264" stroke-width="2" fill="none"/>
                  </svg>
                </span>
              </button>
            </div>
            <small class="form-help">Password must be at least 6 characters long</small>
          </div>

          <div class="form-group">
            <%= form.label :password_confirmation, "Confirm New Password", class: "form-label" %>
            <div class="password-input-wrapper" data-controller="password-visibility">
              <%= form.password_field :password_confirmation, 
                  placeholder: "Confirm new password", 
                  class: "form-input password-input",
                  required: true,
                  minlength: 6,
                  autocomplete: "new-password",
                  data: { "password-visibility-target": "input" },
                  "aria-label": "Password is hidden" %>
              <button type="button" 
                      class="password-toggle-btn" 
                      data-action="click->password-visibility#toggle"
                      aria-label="Toggle password visibility">
                <span class="password-toggle-icon" data-password-visibility-target="icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="#0e3264" stroke-width="2" fill="none"/>
                    <circle cx="12" cy="12" r="3" stroke="#0e3264" stroke-width="2" fill="none"/>
                  </svg>
                </span>
              </button>
            </div>
            <small class="form-help">Re-enter your new password</small>
          </div>

          <div class="password-strength" id="password-strength">
            <div class="strength-indicator">
              <div class="strength-bar" id="strength-bar"></div>
            </div>
            <small id="strength-text">Password strength: </small>
          </div>

          <div class="form-group">
            <%= form.submit "Reset Password", class: "btn btn-primary btn-full", id: "reset-btn" %>
          </div>
        <% end %>

        <div class="auth-links">
          <%= link_to "Back to Login", login_path, class: "link-secondary" %>
        </div>
      </div>
    </div>

    <style>
      .auth-body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
        padding: 20px;
      }

      .auth-container {
        width: 100%;
        max-width: 400px;
      }

      .auth-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 40px;
        text-align: center;
      }

      .auth-header h1 {
        color: #2c3e50;
        font-size: 28px;
        font-weight: 600;
        margin: 0 0 10px 0;
      }

      .auth-header p {
        color: #6c757d;
        font-size: 16px;
        margin: 0 0 30px 0;
        line-height: 1.5;
      }

      .auth-form {
        text-align: left;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .form-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      /* Password toggle styles */
      .password-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
      }

      .password-input {
        padding-right: 3rem !important; /* Make space for toggle button */
      }

      .password-toggle-btn {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem;
        color: #0e3264;
        transition: all 0.3s ease;
        border-radius: 6px;
        z-index: 2;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
      }

      .password-toggle-btn:hover {
        background-color: rgba(14, 50, 100, 0.1);
        transform: translateY(-50%) scale(1.05);
      }

      .password-toggle-btn:focus {
        outline: 2px solid #0e3264;
        outline-offset: 2px;
        background-color: rgba(14, 50, 100, 0.1);
      }

      .password-toggle-btn:active {
        transform: translateY(-50%) scale(0.95);
      }

      .password-toggle-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        pointer-events: none;
      }

      .password-toggle-icon svg {
        transition: all 0.2s ease;
      }

      .form-help {
        display: block;
        color: #6c757d;
        font-size: 12px;
        margin-top: 5px;
      }

      .password-strength {
        margin-bottom: 20px;
      }

      .strength-indicator {
        width: 100%;
        height: 4px;
        background-color: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 5px;
      }

      .strength-bar {
        height: 100%;
        width: 0%;
        transition: all 0.3s ease;
        border-radius: 2px;
      }

      .strength-weak { background-color: #dc3545; }
      .strength-fair { background-color: #ffc107; }
      .strength-good { background-color: #17a2b8; }
      .strength-strong { background-color: #28a745; }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-full {
        width: 100%;
      }

      .auth-links {
        margin-top: 20px;
        text-align: center;
      }

      .link-secondary {
        color: #6c757d;
        text-decoration: none;
        font-size: 14px;
      }

      .link-secondary:hover {
        color: #667eea;
        text-decoration: underline;
      }
    </style>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const passwordInput = document.getElementById('user_password');
        const confirmInput = document.getElementById('user_password_confirmation');
        const strengthBar = document.getElementById('strength-bar');
        const strengthText = document.getElementById('strength-text');
        const resetBtn = document.getElementById('reset-btn');

        function checkPasswordStrength(password) {
          let score = 0;
          let feedback = '';

          if (password.length >= 6) score++;
          if (password.length >= 8) score++;
          if (/[a-z]/.test(password)) score++;
          if (/[A-Z]/.test(password)) score++;
          if (/[0-9]/.test(password)) score++;
          if (/[^A-Za-z0-9]/.test(password)) score++;

          if (score < 2) {
            strengthBar.className = 'strength-bar strength-weak';
            strengthBar.style.width = '25%';
            feedback = 'Weak';
          } else if (score < 4) {
            strengthBar.className = 'strength-bar strength-fair';
            strengthBar.style.width = '50%';
            feedback = 'Fair';
          } else if (score < 5) {
            strengthBar.className = 'strength-bar strength-good';
            strengthBar.style.width = '75%';
            feedback = 'Good';
          } else {
            strengthBar.className = 'strength-bar strength-strong';
            strengthBar.style.width = '100%';
            feedback = 'Strong';
          }

          strengthText.textContent = `Password strength: ${feedback}`;
        }

        function validateForm() {
          const password = passwordInput.value;
          const confirmPassword = confirmInput.value;
          const isValid = password.length >= 6 && password === confirmPassword;
          
          resetBtn.disabled = !isValid;
          return isValid;
        }

        passwordInput.addEventListener('input', function() {
          checkPasswordStrength(this.value);
          validateForm();
        });

        confirmInput.addEventListener('input', validateForm);

        // Initial validation
        validateForm();
      });
    </script>
  </body>
</html>
